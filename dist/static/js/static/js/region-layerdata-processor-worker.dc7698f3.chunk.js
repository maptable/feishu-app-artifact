(()=>{"use strict";var e={23783:(e,o,t)=>{var n=t(20780),a=t(8942),i=t.n(a),r=t(74720),l=t.n(r),s=(t(34362),t(55349)),d=t.n(s),u=t(17646),c=t.n(u),p=t(56356),m=t.n(p),g=t(22787),f=t(468),v=t.n(f),h=t(53813),y=t.n(h),b=t(88716),I=t.n(b),w=t(82813),N=t.n(w),S=t(42015),x=t(36441),F=t(46131),O=t(40978),M=t(13424),V=t(29630),D=t(93033);const j="optimized",C=("".concat("https://icon-cdn.maptable.com","/assets/boundary_data"),85);let _,k,z=null;async function B(e,o){const{id:t,locale:a,mapInfo:r,tableNode:s,regionGeojson:u,allIndexOptions:p,dashboardData:f}=e,{hideEmpty:h}=r.regionConfig;o({id:t,type:"processing",data:{data:u,notMatchedItems:[],totalItems:[]}});try{var b,w;const e=await async function(e){var o;let{locale:t,mapInfo:a,tableNode:r,geojson:s,allIndexOptions:u,dashboardData:p}=e;const f=!i()(z,s),h=y()(s);if(h&&(z=h),"optimized"===j&&"region"===(null===a||void 0===a||null===(o=a.regionConfig)||void 0===o?void 0:o.dimension))return await(0,D.l)({locale:t,mapInfo:a,tableNode:r,geojson:h,allIndexOptions:u,dashboardData:p,hasGeoJSONChanged:f});const b=[],I=[],{regionDimensionFieldID:w,regionIndexStatsFieldID:F,specifyByFieldID:B,regionConfig:J}=a,{dimension:P,aggregateBy:T,regionId:Z,indexStatsMethod:E}=J;if(!w||!F||!h||!r)return null===h||void 0===h||h.features.map((e=>(e.properties=v()(e.properties,["aggregationValue","aggregationFormatValue"]),e))),{computingGeoJSON:h};(_&&!i()(w,_)||k&&!i()(F,k))&&(null===h||void 0===h||h.features.map((e=>(e.properties=v()(e.properties,["aggregationValue","aggregationFormatValue"]),e)))),_=w,k=F;const H=Z||"china";if("region"===P){const e=N()(u),o=new n.Z(e,S.Hk),a=new n.Z(e,S.Yk),i=r.rows||[],l=r.columns||[],s=JSON.stringify((null===l||void 0===l?void 0:l.find((e=>e.id===F)))||{}),g=l.find((e=>e.id===w)),v=l.find((e=>e.id===B)),y=new Map,O=new Map(h.features.map((e=>{var o;return[null===(o=e.properties)||void 0===o?void 0:o.id,e]}))),D=new Map(e.map((e=>[e.id,e.parentId]))),j=!!v;let _=[],k=E;p?(c()(p,((e,o)=>{c()(e,((e,t)=>{_.push({regionName:m()(o),specifyByName:j?t:null,value:e.value,dashboardValue:"mean"===k?e:void 0,rowId:o})}))})),"count"!==E&&"nonEmptyCount"!==E||(k="sum")):_=i.reduce(((e,o,t)=>{const n=(0,M.hb)(o,g);if(!n)return e;const a=o.cells[F],i=o.id;return e.push({regionName:n,specifyByName:(0,M.hb)(o,v),value:a,rowId:i}),e}),[]),I.push(..._);const z=await(0,V.zK)(H),J=new Set(_.map((e=>"".concat(e.regionName,"-").concat(e.specifyByName||"","-").concat(T||"")))),P=await Promise.all([...J].map((e=>(0,V.TK)(e,z)))),Z=new Map([...J].map(((e,o)=>[e,P[o]]))),R={};for(const t of _){var K;if(t.regionName&&t.regionName.length>C){b.push(t);continue}const e="".concat(t.regionName,"-").concat(t.specifyByName||"","-").concat(T||"");let n=Z.get(e);if(n||f){var U;const i=await(0,M.Lu)(t.regionName,a,o);if(null===i||void 0===i||!i.length){R[e]=null;continue}n=await(0,M.XN)({directFuzzyMatchResult:i,specifyMatchValue:t.specifyByName,strictFUse:a,fuzzyFUse:o,aggregateBy:T}),((null===(U=n)||void 0===U?void 0:U.score)||0)>S.a&&(n=null),Z.set(e,n||null),R[e]=n||null}if(d()(n)){b.push(t);continue}const i=null===(K=n.item)||void 0===K?void 0:K.id;if(!i){b.push(t);continue}const r=t.value,l=t.rowId;y.has(i)||y.set(i,[]),y.get(i).push({value:r,rowId:l,dashboardValue:t.dashboardValue});let s=i;for(let o=0;o<2;o++){const e=D.get(s);if(!e)break;y.has(e)||y.set(e,[]),y.get(e).push({value:r,rowId:l,dashboardValue:t.dashboardValue}),s=e}}await(0,V.Iv)(R,z);for(const[n,r]of y){var q,A,L;const e=O.get(n);if(!e)continue;if(n===x.q)continue;const o="zh-CN"===t?(null===(q=e.properties)||void 0===q?void 0:q.display_name)||(null===(A=e.properties)||void 0===A?void 0:A.name_zh):null===(L=e.properties)||void 0===L?void 0:L.name_en;e.type="Feature";let a=r.map((e=>e.value));if("mean"===k&&r.length>1){const{sum:e,count:o,isDashboardValue:t}=r.reduce(((e,o)=>(o.dashboardValue&&(e.sum+=o.dashboardValue.sum||0,e.count+=o.dashboardValue.count||0,e.isDashboardValue=!0),e)),{sum:0,count:0,isDashboardValue:!1});t&&(a=[o>0?e/o:0])}const i=G({aggregationValue:a,indexStatsMethod:E,columns:l,regionDimensionFieldID:w,regionIndexStatsFieldID:F,name:o});e.properties={...e.properties||{},name:o,tooltip:i,aggregationValue:a,aggregationMethod:k,rowIds:r.map((e=>e.rowId)),indexStatsColumn:s}}}else if("coordinate"===P){const e=r.rows,o=r.columns,n=new Map,a=JSON.stringify((null===o||void 0===o?void 0:o.find((e=>e.id===F)))||{});for(const i of e){const e=i.cells[w];if(e)try{const r=(0,O.HF)(e);if("Point"!==r.type)continue;let s=!1;I.push({regionName:i.cells[w],specifyByName:null,value:0,rowId:i.id});for(const e of h.features){const d="zh-CN"===t?l()(e,"properties.display_name")||l()(e,"properties.name_zh"):l()(e,"properties.name_en");if((0,g.Z)(r.coordinates,e)){var R,X,Y;const t=null===(R=e.properties)||void 0===R?void 0:R.id;n.has(t)||n.set(t,[]),n.get(t).push({value:i.cells[F],rowId:i.id});const r=(null===(X=n.get(t))||void 0===X?void 0:X.map((e=>e.value)))||[],l=G({aggregationValue:r,indexStatsMethod:E,columns:o,regionDimensionFieldID:w,regionIndexStatsFieldID:F,name:d});e.type="Feature",e.properties={...e.properties||{},tooltip:l,name:d,aggregationValue:r,rowIds:(null===(Y=n.get(t))||void 0===Y?void 0:Y.map((e=>e.rowId)))||[],indexStatsColumn:a},s=!0;break}}s||b.push({rowId:i.id,regionName:l()(i.cells,"".concat(w,"-fullAddress"),i.cells[w]),value:0,specifyByName:null})}catch{continue}}}return{computingGeoJSON:h,notMatchedItems:b,totalItems:I}}({locale:a,mapInfo:r,tableNode:s,geojson:u,allIndexOptions:p,dashboardData:f}),F=h?null===(b=e.computingGeoJSON)||void 0===b?void 0:b.features.filter((e=>{var o;return!I()(null===(o=e.properties)||void 0===o?void 0:o.aggregationValue)})):null===(w=e.computingGeoJSON)||void 0===w?void 0:w.features;o({id:t,type:"success",data:{data:{...e.computingGeoJSON,features:null!==F&&void 0!==F?F:[]},notMatchedItems:e.notMatchedItems||[],totalItems:e.totalItems||[]}})}catch(F){o({id:t,type:"failed",data:{data:u,notMatchedItems:[],totalItems:[]}})}}function G(e){var o,t;let{aggregationValue:n,indexStatsMethod:a,columns:i,regionDimensionFieldID:r,regionIndexStatsFieldID:l,name:s}=e;const d=(0,S.Bb)(n,a),u=null===i||void 0===i||null===(o=i.find((e=>e.id===r)))||void 0===o?void 0:o.name,c=null===i||void 0===i||null===(t=i.find((e=>e.id===l)))||void 0===t?void 0:t.name,p=d?(0,F.IG)(d):null;return"".concat(u,": ").concat(s,"\n").concat(null!==c&&void 0!==c?c:"Count",": ").concat(p)}const J=globalThis;J.onmessage=e=>{B(e.data,J.postMessage)}},46131:(e,o,t)=>{t.d(o,{IG:()=>i});t(74720),t(7070),t(75538),t(78587),t(75091);var n=t(99540),a=t.n(n);t(81659),t(21740),t(91671),t(42015),t(97102);function i(e){return function(e){const o=[{value:1e9,symbol:"b"},{value:1e6,symbol:"m"},{value:1e3,symbol:"k"}];if(e<1e3)return e.toString();for(const t of o)if(e>=t.value){const o=e/t.value,n=Math.floor(o).toString().length,a=Math.max(0,4-n);return o.toFixed(a).replace(/\.?0+$/,"")+t.symbol}return e.toString()}(function(e){if(0!==e&&e>-.1&&e<1){let o,t=e;for(o=0;o<10&&t>-.1&&t<1;o++)t*=10;return parseFloat(e.toFixed(o+2))}return parseFloat(a()(e).toFixed(3))}(e))}},91671:(e,o,t)=>{}},o={};function t(n){var a=o[n];if(void 0!==a)return a.exports;var i=o[n]={id:n,loaded:!1,exports:{}};return e[n].call(i.exports,i,i.exports,t),i.loaded=!0,i.exports}t.m=e,t.x=()=>{var e=t.O(void 0,[638,190,698,253,818,298],(()=>t(23783)));return e=t.O(e)},(()=>{var e=[];t.O=(o,n,a,i)=>{if(!n){var r=1/0;for(u=0;u<e.length;u++){n=e[u][0],a=e[u][1],i=e[u][2];for(var l=!0,s=0;s<n.length;s++)(!1&i||r>=i)&&Object.keys(t.O).every((e=>t.O[e](n[s])))?n.splice(s--,1):(l=!1,i<r&&(r=i));if(l){e.splice(u--,1);var d=a();void 0!==d&&(o=d)}}return o}i=i||0;for(var u=e.length;u>0&&e[u-1][2]>i;u--)e[u]=e[u-1];e[u]=[n,a,i]}})(),t.n=e=>{var o=e&&e.__esModule?()=>e.default:()=>e;return t.d(o,{a:o}),o},t.d=(e,o)=>{for(var n in o)t.o(o,n)&&!t.o(e,n)&&Object.defineProperty(e,n,{enumerable:!0,get:o[n]})},t.f={},t.e=e=>Promise.all(Object.keys(t.f).reduce(((o,n)=>(t.f[n](e,o),o)),[])),t.u=e=>638===e?"static/js/638.48b925df.js":190===e?"static/js/190.8bd7f8f0.js":"static/js/"+e+"."+{253:"92fe4cea",298:"7e61ccb2",698:"4d2febf4",818:"58075517"}[e]+".chunk.js",t.miniCssF=e=>{},t.g=function(){if("object"===typeof globalThis)return globalThis;try{return this||new Function("return this")()}catch(e){if("object"===typeof window)return window}}(),t.o=(e,o)=>Object.prototype.hasOwnProperty.call(e,o),t.r=e=>{"undefined"!==typeof Symbol&&Symbol.toStringTag&&Object.defineProperty(e,Symbol.toStringTag,{value:"Module"}),Object.defineProperty(e,"__esModule",{value:!0})},t.nmd=e=>(e.paths=[],e.children||(e.children=[]),e),t.p="./",(()=>{var e={524:1};t.f.i=(o,n)=>{e[o]||importScripts(t.p+t.u(o))};var o=self.webpackChunkmaptable_frontend=self.webpackChunkmaptable_frontend||[],n=o.push.bind(o);o.push=o=>{var a=o[0],i=o[1],r=o[2];for(var l in i)t.o(i,l)&&(t.m[l]=i[l]);for(r&&r(t);a.length;)e[a.pop()]=1;n(o)}})(),(()=>{var e=t.x;t.x=()=>Promise.all([638,190,698,253,818,298].map(t.e,t)).then(e)})();t.x()})();