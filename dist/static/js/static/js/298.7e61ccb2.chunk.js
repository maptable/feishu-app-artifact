"use strict";(self.webpackChunkmaptable_frontend=self.webpackChunkmaptable_frontend||[]).push([[298],{40978:(e,t,a)=>{a.d(t,{HF:()=>l});var i=a(37383),n=a(57323),s=a.n(n);class o{constructor(e){s()(this,"i",0),this.raw=e}peek(){if(this.i>this.raw.length)throw new Error("unexpected EOF");return this.raw[this.i]}skipWs(){if(!(this.i>=this.raw.length))for(let e=this.i;e<this.raw.length;e++){if(!r(this.raw.charAt(e)))return;this.i+=1}}scanStart(){this.skipWs();const e=this.peek();if("("!==e)throw new Error("expect '(' got ".concat(e));this.i++}scanContinue(){this.skipWs();const e=this.peek(),t=","===e;if(!t&&")"!==e)throw new Error("expect ',' or ')' got ".concat(e));return this.i++,t}scanCircle(){this.scanStart();const[e,t]=this.scanCoordinate();if(!t){const e=this.peek();throw new Error("expect ',' got ".concat(e))}this.i++,this.skipWs();const a=this.scanNumber(),i=this.peek();if(")"!==i)throw new Error("expect ')' got ".concat(i));return this.i++,[e[0],e[1],a]}scanCirlces(){this.scanStart();const e=[];for(;;){const t=this.scanCircle();e.push(t);if(!this.scanContinue())break}return e}scanNumber(){this.skipWs();let e="",t=this.peek();for(;c(t);)this.i+=1,e+=t,t=this.peek();const a=Number(e);if(Number.isNaN(a))throw new Error("number parse error ".concat(e));return a}scanCoordinate(){if(this.skipWs(),this.i>this.raw.length)throw new Error("unexpected EOF");const e=this.scanNumber();this.skipWs();const t=this.scanNumber();this.skipWs();const a=this.peek(),i=","===a;if(!i&&")"!==a)throw new Error("expect ',' or ')' got ".concat(a));return this.i++,[[e,t],i]}scanCoordinates(e){if(this.scanStart(),e)try{this.scanStart()}catch(a){e=!1}const t=[];for(;;){const[a,i]=this.scanCoordinate();if(t.push(a),!i){if(e){if(this.scanContinue()){this.scanStart();continue}}return t}if(e)throw new Error("expect ')' got ','")}}scanPolyData(e){this.scanStart();const t=[];for(;;){const a=this.scanCoordinates(!1);if(e){if(a.length<4)throw new Error("a polygon ring must have at least 4 points, got ".concat(a.length));if(a[0][0]!==a[a.length-1][0]||a[0][1]!==a[a.length-1][1])throw new Error("a polygon ring must be closed")}else if(a.length<2)throw new Error("must have at least 2 points, got ".concat(a.length));if(t.push(a),!this.scanContinue())return t}}scanMultiPolyData(){this.scanStart();const e=[];for(;;){const t=this.scanPolyData(!0);if(e.push(t),!this.scanContinue())return e}}scanIndent(){if(this.skipWs(),this.i>=this.raw.length)throw new Error("unexpected EOF");let e="",t=0;for(t=this.i;t<this.raw.length;t++){const a=this.raw.charAt(t);if(!d(a))break;e+=a.toUpperCase(),this.i+=1}if(0===e.length)throw new Error("indent not found");return e}scanGeometry(){const e=this.scanIndent();let t;switch(e){case"CIRCLE":t={type:"Circle",coordinates:this.scanCircle()};break;case"MULTICIRCLE":t={type:"MultiCircle",coordinates:this.scanCirlces()};break;case"POINT":{const e=this.scanCoordinates(!1);if(1!==e.length)throw new Error("expect 1 got ".concat(e.length," points"));t={type:"Point",coordinates:e[0]};break}case"MULTIPOINT":t={type:"MultiPoint",coordinates:this.scanCoordinates(!0)};break;case"LINESTRING":{const e=this.scanCoordinates(!1);if(e.length<2)throw new Error("must have at least 2 points, got ".concat(e.length));t={type:"LineString",coordinates:e};break}case"POLYGON":t={type:"Polygon",coordinates:this.scanPolyData(!0)};break;case"MULTIPOLYGON":t={type:"MultiPolygon",coordinates:this.scanMultiPolyData()};break;case"MULTILINESTRING":t={type:"MultiLineString",coordinates:this.scanPolyData(!1)};break;default:throw new Error("unknown geometry ".concat(e))}if(this.i+1<=this.raw.length)throw new Error("expect EOF");return t}}function r(e){return 1===e.length&&[" ","\n","\t","\r"].includes(e)}function c(e){return[".","-","0","1","2","3","4","5","6","7","8","9"].includes(e)}function d(e){return 1===e.length&&e.match(/[a-zA-Z]/i)}a(58205);a(40517),a(67045),a(80128),a(80593);i.default.GCJ02,i.default.WGS84,i.default.BD09MC;function l(e){return function(e){return new o(e).scanGeometry()}(e)}},36441:(e,t,a)=>{a.d(t,{q:()=>i});const i="china-ADM1-nineDashLine"},42015:(e,t,a)=>{a.d(t,{Bb:()=>m,Hk:()=>h,Yk:()=>f,a:()=>g,yy:()=>u});var i=a(79129),n=a(27077),s=a(42514),o=a(6200),r=a(35546),c=a(70323),d=a(89063),l=a.n(d);"".concat("https://icon-cdn.maptable.com","/assets/boundary_data");const u={admin0:0,admin1:1,admin2:2,admin3:3},h=((0,i.Em)({id:"qIy+j6",defaultMessage:"Admin0"}),(0,i.Em)({id:"Qxkkdf",defaultMessage:"Admin1"}),(0,i.Em)({id:"8IvwT/",defaultMessage:"Admin2"}),(0,i.Em)({id:"Lci7UK",defaultMessage:"Admin3"}),{minMatchCharLength:2,keys:["name_zh","name_en","name_local"],includeScore:!0}),f={isCaseSensitive:!1,includeScore:!0,threshold:0,keys:["name_alias","iso","iso2"]};const g=.2;function m(e,t){switch(t){case"sum":return(0,n.Z)(e);case"min":return(0,s.Z)(e);case"max":return(0,o.Z)(e);case"mean":return(0,r.Z)(e);case"median":return(0,c.Z)(e);case"nonEmptyCount":return l()(e.filter((e=>null!=e)));default:return l()(e)}}(0,i.Em)({id:"jqdzk6",defaultMessage:"World"}),(0,i.Em)({id:"1q/ois",defaultMessage:"China"}),(0,i.Em)({id:"whQZpU",defaultMessage:"USA"}),(0,i.Em)({id:"3Rh+pv",defaultMessage:"Japan"}),(0,i.Em)({id:"PGzyr2",defaultMessage:"Germany"}),(0,i.Em)({id:"9N69Wd",defaultMessage:"UK"}),(0,i.Em)({id:"9KADbj",defaultMessage:"France"}),(0,i.Em)({id:"VzQxqn",defaultMessage:"Italy"}),(0,i.Em)({id:"2abiy0",defaultMessage:"Canada"}),(0,i.Em)({id:"zJ+Qdi",defaultMessage:"Brazil"}),(0,i.Em)({id:"QXG+La",defaultMessage:"Mexico"}),(0,i.Em)({id:"rhaGlx",defaultMessage:"Singapore"}),(0,i.Em)({id:"vQOevT",defaultMessage:"Indonesia"}),(0,i.Em)({id:"b7zond",defaultMessage:"Malaysia"}),(0,i.Em)({id:"+ieU8R",defaultMessage:"Vietnam"}),(0,i.Em)({id:"dQZuWX",defaultMessage:"Thailand"}),(0,i.Em)({id:"RRQ7fk",defaultMessage:"Philippines"}),(0,i.Em)({id:"ZwXv1C",defaultMessage:"Austria"}),(0,i.Em)({id:"o5InVy",defaultMessage:"Belgium"}),(0,i.Em)({id:"OjT4Gq",defaultMessage:"Denmark"}),(0,i.Em)({id:"OIc/xw",defaultMessage:"Finland"}),(0,i.Em)({id:"cOtCHW",defaultMessage:"Sweden"}),(0,i.Em)({id:"yil/vB",defaultMessage:"Greece"}),(0,i.Em)({id:"hT/s2i",defaultMessage:"Netherlands"}),(0,i.Em)({id:"SZjU9E",defaultMessage:"Poland"}),(0,i.Em)({id:"67jBS8",defaultMessage:"Portugal"}),(0,i.Em)({id:"GL9Msi",defaultMessage:"Spain"}),(0,i.Em)({id:"gEWjsM",defaultMessage:"Bangladesh"}),(0,i.Em)({id:"fIBorD",defaultMessage:"Congo-Kinshasa"}),(0,i.Em)({id:"BIR9MS",defaultMessage:"Egypt"}),(0,i.Em)({id:"u5SBAU",defaultMessage:"Pakistan"}),(0,i.Em)({id:"t50FYQ",defaultMessage:"Zambia"}),(0,i.Em)({id:"D4A2LZ",defaultMessage:"Australia"}),(0,i.Em)({id:"OhkbDU",defaultMessage:"Russia"}),(0,i.Em)({id:"tnrxhT",defaultMessage:"South Korea"}),(0,i.Em)({id:"k/pu+/",defaultMessage:"Turkey"}),(0,i.Em)({id:"cbMqh0",defaultMessage:"Saudi Arabia"}),(0,i.Em)({id:"ERkh0f",defaultMessage:"Switzerland"}),(0,i.Em)({id:"wHkOq4",defaultMessage:"Argentina"}),(0,i.Em)({id:"fGxzwb",defaultMessage:"Ireland"}),(0,i.Em)({id:"vwXIZQ",defaultMessage:"Israel"}),(0,i.Em)({id:"eMHa+3",defaultMessage:"United Arab Emirates"}),(0,i.Em)({id:"mdq/wu",defaultMessage:"Norway"}),(0,i.Em)({id:"XR8z3v",defaultMessage:"South Africa"})},29630:(e,t,a)=>{a.d(t,{Iv:()=>d,TK:()=>c,zK:()=>r});var i=a(33382);const n="MT-RegionMatchDB",s="matchCache",o=20251103;async function r(e){const t="".concat(n,"-").concat(e);try{return await(0,i.X3)(t,o,{upgrade(e,t){if(t<o&&e.objectStoreNames.contains(s)&&e.deleteObjectStore(s),!e.objectStoreNames.contains(s)){e.createObjectStore(s,{keyPath:"key"}).createIndex("by-key","key",{unique:!0})}}})}catch{}}async function c(e,t){try{if(!t)return;const a=await t.getFromIndex(s,"by-key",e);return null===a||void 0===a?void 0:a.value}catch{}}async function d(e,t){try{if(!t)return;const a=t.transaction(s,"readwrite"),i=a.objectStore(s);await Promise.all([...Object.entries(e).map((e=>{let[t,a]=e;return i.put({key:t,value:a})})),a.done])}catch{}}},13424:(e,t,a)=>{a.d(t,{Lu:()=>r,XN:()=>d,cn:()=>c,hb:()=>o});var i=a(56356),n=a.n(i),s=a(42015);function o(e,t){var a;if(!t)return null;const i=e.cells[t.id];if("singleChoice"===t.type){var s;const e=null===(s=t.typeOptions)||void 0===s?void 0:s.choices.find((e=>e.id===i));return n()((null===e||void 0===e?void 0:e.name)||"")}if("lookup"===t.type&&"singleChoice"===(null===(a=t.typeOptions)||void 0===a?void 0:a.lookupColumnType)){var o;const e=null===(o=t.typeOptions.lookupColumnTypeOptions)||void 0===o?void 0:o.choices.find((e=>Array.isArray(i)?i.includes(e.id):e.id===i));return n()((null===e||void 0===e?void 0:e.name)||"")}return n()(i)}const r=async(e,t,a)=>{var i;if(!e)return null;const n=t.search(e),s=a.search(e),o=[],r=new Set,c=n.find((e=>{var t;return Boolean(null===(t=e.item)||void 0===t?void 0:t.name_zh)}));null!==c&&void 0!==c&&null!==(i=c.item)&&void 0!==i&&i.id&&(r.add(c.item.id),o.push(c));for(const l of s){var d;const e=null===(d=l.item)||void 0===d?void 0:d.id;e&&!r.has(e)&&(o.push(l),r.add(e))}return o},c=(e,t)=>{if(0===(null===e||void 0===e?void 0:e.length)||!t)return e;const a=s.yy[t];return e.filter((e=>{var t;return Number(null===(t=e.item.level)||void 0===t?void 0:t.replace("ADM",""))>=a}))},d=async e=>{var t;let{directFuzzyMatchResult:a,specifyMatchValue:i,strictFUse:n,fuzzyFUse:s,aggregateBy:o}=e;const d=c(a,o);if(!d.length)return null;const l=null===d||void 0===d?void 0:d[0];if(!i||!l.item.parentId)return l;const u=await r(i,n,s);if(!u)return l;const h=u.filter((e=>"ADM3"!==e.item.level)),f=null===h||void 0===h?void 0:h[0];if(!f)return l;if(null!==(t=f.item)&&void 0!==t&&t.parentId){return d.find((e=>e.item.parentId===f.item.id))}return d.find((e=>e.item.gid1===f.item.gid1))}},93033:(e,t,a)=>{a.d(t,{l:()=>S});var i=a(57323),n=a.n(i),s=a(20780),o=a(55349),r=a.n(o),c=a(17646),d=a.n(c),l=a(56356),u=a.n(l),h=a(468),f=a.n(h),g=a(82813),m=a.n(g),p=a(42015),y=a(36441),w=a(46131),M=a(29630),v=a(13424);class E{constructor(e,t){n()(this,"cache",new Map),this.strictSpecifyFUse=e,this.fuzzySpecifyFUse=t}async getSpecifyMatch(e){if(this.cache.has(e))return this.cache.get(e);const t=await(0,v.Lu)(e,this.strictSpecifyFUse,this.fuzzySpecifyFUse);if(null===t||void 0===t||!t.length)return this.cache.set(e,null),null;const a=(null===t||void 0===t?void 0:t[0])||null;return this.cache.set(e,a),a}async preloadSpecifyMatches(e){const t=[...e].filter((e=>e&&!this.cache.has(e)));for(let a=0;a<t.length;a+=20){const e=t.slice(a,a+20);await Promise.all(e.map((e=>this.getSpecifyMatch(e))))}}clear(){this.cache.clear(),this.strictSpecifyFUse=new s.Z([]),this.fuzzySpecifyFUse=new s.Z([])}}class I{constructor(e,t){this.strictFUse=e.strictFUse,this.fuzzyFUse=e.fuzzyFUse,this.specifyCache=new E(e.strictSpecifyFUse,e.fuzzySpecifyFUse),this.aggregateBy=t}async findBestMatchResultOptimized(e){var t;let{directFuzzyMatchResult:a,specifyMatchValue:i}=e;const n=(0,v.cn)(a,this.aggregateBy);if(!n.length)return null;const s=n[0];if(!i||!s.item.parentId)return s;const o=await this.specifyCache.getSpecifyMatch(i);if(!o)return s;if(null!==(t=o.item)&&void 0!==t&&t.parentId){return n.find((e=>e.item.parentId===o.item.id))||s}return n.find((e=>e.item.gid1===o.item.gid1))||s}async preloadSpecifyMatches(e){const t=new Set;e.forEach((e=>{e.specifyByName&&u()(e.specifyByName)&&t.add(u()(e.specifyByName))})),await this.specifyCache.preloadSpecifyMatches(t)}async processRegionMatching(e,t,a){const i=[],n=new Map,s={},o=new Map;for(const r of e){if(!r.regionName||r.regionName.length>85){i.push(r);continue}const e=r.regionName;o.has(e)||o.set(e,[]),o.get(e).push(r)}for(const[d,l]of o){const e=await(0,v.Lu)(d,this.strictFUse,this.fuzzyFUse);if(null===e||void 0===e||!e.length){l.forEach((e=>{const t="".concat(e.regionName,"-").concat(e.specifyByName||"","-").concat(this.aggregateBy||"");s[t]=null,i.push(e)}));continue}const o=new Map;l.forEach((e=>{const t=e.specifyByName||"";o.has(t)||o.set(t,[]),o.get(t).push(e)}));for(const[,d]of o){const o=d[0],l="".concat(o.regionName,"-").concat(o.specifyByName||"","-").concat(this.aggregateBy||"");let u=await(0,M.TK)(l,t);var c;if(void 0===u||a)u=await this.findBestMatchResultOptimized({directFuzzyMatchResult:e,specifyMatchValue:o.specifyByName}),((null===(c=u)||void 0===c?void 0:c.score)||0)>p.a&&(u=null),s[l]=u||null;d.forEach((e=>{r()(u)?i.push(e):n.set(e.rowId,u)}))}}return{matchResults:n,notMatchedItems:i,cacheToWrite:s}}clear(){this.specifyCache.clear(),this.fuzzyFUse=new s.Z([]),this.strictFUse=new s.Z([])}}async function S(e){let{locale:t,mapInfo:a,tableNode:i,geojson:n,allIndexOptions:o,dashboardData:r,hasGeoJSONChanged:c}=e;const l=[],h=[],g=n,{regionDimensionFieldID:w,regionIndexStatsFieldID:E,specifyByFieldID:S,regionConfig:k}=a,{dimension:C,aggregateBy:z,regionId:N,indexStatsMethod:F}=k;if("region"!==C||!w||!E||!g||!i)return null===g||void 0===g||g.features.map((e=>(e.properties=f()(e.properties,["aggregationValue","aggregationFormatValue"]),e))),{computingGeoJSON:g,notMatchedItems:l,totalItems:h};const U=N||"china",D=m()(o),B=i.rows||[],O=i.columns||[],x=JSON.stringify((null===O||void 0===O?void 0:O.find((e=>e.id===E)))||{}),A=O.find((e=>e.id===w)),P=O.find((e=>e.id===S)),R=new Map,T=new Map(g.features.map((e=>{var t;return[null===(t=e.properties)||void 0===t?void 0:t.id,e]}))),V=new Map(D.map((e=>[e.id,e.parentId]))),L=!!P;let Z=[],G=F;r?(d()(r,((e,t)=>{d()(e,((e,a)=>{Z.push({regionName:u()(t),specifyByName:L?a:null,value:e.value,dashboardValue:"mean"===G?e:void 0,rowId:"".concat(t,"-").concat(a)})}))})),"count"!==F&&"nonEmptyCount"!==F||(G="sum")):Z=B.reduce(((e,t)=>{const a=(0,v.hb)(t,A);if(!a)return e;const i=t.cells[E],n=t.id;return e.push({regionName:a,specifyByName:(0,v.hb)(t,P),value:i,rowId:n}),e}),[]),h.push(...Z);const W=new I(function(e){const t=new s.Z(e,p.Hk),a=new s.Z(e,p.Yk),i=e.filter((e=>"ADM3"!==e.level)),n=new s.Z(i,p.Hk);return{strictFUse:a,fuzzyFUse:t,strictSpecifyFUse:new s.Z(i,p.Yk),fuzzySpecifyFUse:n}}(D),z);await W.preloadSpecifyMatches(Z);const j=await(0,M.zK)(U);let q=new Map;try{const e=await W.processRegionMatching(Z,j,c);q=e.matchResults,l.push(...e.notMatchedItems),await(0,M.Iv)(e.cacheToWrite,j)}finally{W.clear();try{null===j||void 0===j||j.close()}catch{}}for(const[s,d]of q){var _;const e=Z.find((e=>e.rowId===s));if(!e||!d)continue;const t=null===(_=d.item)||void 0===_?void 0:_.id;if(!t)continue;const a=e.value;R.has(t)||R.set(t,[]),R.get(t).push({value:a,rowId:e.rowId,dashboardValue:e.dashboardValue});let i=t;for(let n=0;n<2;n++){const t=V.get(i);if(!t)break;R.has(t)||R.set(t,[]),R.get(t).push({value:a,rowId:e.rowId,dashboardValue:e.dashboardValue}),i=t}}for(const[s,d]of R){var Q,K,H;const e=T.get(s);if(!e||s===y.q)continue;const a="zh-CN"===t?(null===(Q=e.properties)||void 0===Q?void 0:Q.display_name)||(null===(K=e.properties)||void 0===K?void 0:K.name_zh):null===(H=e.properties)||void 0===H?void 0:H.name_en;e.type="Feature";let i=d.map((e=>e.value));if("mean"===G&&d.length>1){const{sum:e,count:t,isDashboardValue:a}=d.reduce(((e,t)=>(t.dashboardValue&&(e.sum+=t.dashboardValue.sum||0,e.count+=t.dashboardValue.count||0,e.isDashboardValue=!0),e)),{sum:0,count:0,isDashboardValue:!1});a&&(i=[t>0?e/t:0])}const n=b({aggregationValue:i,indexStatsMethod:F,columns:O,regionDimensionFieldID:w,regionIndexStatsFieldID:E,name:a});e.properties={...e.properties||{},name:a,tooltip:n,aggregationValue:i,aggregationMethod:G,rowIds:d.map((e=>{var t;return null===(t=e.rowId)||void 0===t?void 0:t.split("-")[0]})),indexStatsColumn:x}}return{computingGeoJSON:g,notMatchedItems:l,totalItems:h}}function b(e){var t,a;let{aggregationValue:i,indexStatsMethod:n,columns:s,regionDimensionFieldID:o,regionIndexStatsFieldID:r,name:c}=e;const d=(0,p.Bb)(i,n),l=null===s||void 0===s||null===(t=s.find((e=>e.id===o)))||void 0===t?void 0:t.name,u=null===s||void 0===s||null===(a=s.find((e=>e.id===r)))||void 0===a?void 0:a.name,h=d?(0,w.IG)(d):null;return"".concat(l,": ").concat(c,"\n").concat(null!==u&&void 0!==u?u:"Count",": ").concat(h)}}}]);